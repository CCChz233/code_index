{"summary": "The code defines a pytest plugin for aiohttp that enables asynchronous fixtures. It imports necessary modules and types, including asyncio, pytest, and aiohttp components. The core function `pytest_fixture_setup` modifies fixture definitions to support async functions and async generators. It checks if a fixture is async, ensures the 'loop' fixture is present, and wraps the original fixture function to run within an event loop. For async generators, it handles initial and final yields using the loop. This allows pytest to execute async fixtures seamlessly in aiohttp tests.\nWe need to produce summary directly, no intro phrase. Provide Chinese and English maybe. Should focus on business logic, inputs, outputs. Let's craft.assistantfinal\u5b9e\u73b0\u4e86 **aiohttp** \u9879\u76ee\u5728 **pytest** \u4e2d\u5bf9\u5f02\u6b65 fixture \u7684\u652f\u6301\u3002  \n\n**\u6838\u5fc3\u529f\u80fd**  \n- `pytest_fixture_setup(fixturedef)` \u5728 pytest \u6536\u96c6\u9636\u6bb5\u62e6\u622a fixture \u5b9a\u4e49\u3002  \n- \u5224\u65ad fixture \u7684\u5b9e\u73b0\u5f62\u5f0f\uff1a  \n  - `async def`\uff08\u666e\u901a\u534f\u7a0b\uff09  \n  - `async def` + `yield`\uff08\u5f02\u6b65\u751f\u6210\u5668\uff09  \n  - \u5176\u5b83\uff08\u540c\u6b65\uff09\u76f4\u63a5\u8fd4\u56de\uff0c\u4e0d\u505a\u5904\u7406\u3002  \n- \u82e5 fixture \u4e3a\u5f02\u6b65\uff0c\u9700\u8981 **`loop` fixture**\uff08\u5373\u4e8b\u4ef6\u5faa\u73af\uff09\u4f5c\u4e3a\u4f9d\u8d56\uff1b\u5426\u5219\u629b\u51fa\u5f02\u5e38\u63d0\u793a\u3002  \n- \u4e3a\u5f02\u6b65 fixture \u52a8\u6001\u751f\u6210\u5305\u88c5\u51fd\u6570 `wrapper`\uff0c\u5728\u8fd0\u884c\u65f6\u901a\u8fc7 `request.getfixturevalue(\"loop\")` \u53d6\u5f97\u4e8b\u4ef6\u5faa\u73af\uff0c\u5e76\u4f7f\u7528 `loop.run_until_complete` \u6267\u884c\uff1a  \n  - **\u666e\u901a\u534f\u7a0b** \u2192 \u76f4\u63a5 `run_until_complete` \u8fd4\u56de\u7ed3\u679c\u3002  \n  - **\u5f02\u6b65\u751f\u6210\u5668** \u2192 \u9996\u6b21 `__anext__()` \u53d6\u5f97 yielded \u503c\u4f5c\u4e3a fixture \u7684\u8fd4\u56de\uff1b\u5728\u6d4b\u8bd5\u7ed3\u675f\u65f6\u901a\u8fc7 `request.addfinalizer` \u6ce8\u518c `finalizer`\uff0c\u518d\u6b21\u8c03\u7528 `__anext__()` \u5b8c\u6210\u6e05\u7406\uff08\u6355\u83b7 `StopAsyncIteration` \u8868\u793a\u7ed3\u675f\uff09\u3002  \n- \u82e5\u539f fixture \u53c2\u6570\u5217\u8868\u4e2d\u7f3a\u5c11 `request`\uff0c\u4f1a\u4e34\u65f6\u8865\u5145\u5e76\u5728\u8c03\u7528\u540e\u79fb\u9664\uff0c\u4ee5\u4fdd\u8bc1\u5305\u88c5\u51fd\u6570\u80fd\u591f\u83b7\u53d6 pytest \u7684 `request` \u5bf9\u8c61\u3002  \n\n**\u8f93\u5165**  \n- `fixturedef`\uff1apytest \u5185\u90e8\u7684 `FixtureDef` \u5bf9\u8c61\uff0c\u5305\u542b\u539f\u59cb fixture \u51fd\u6570\u3001\u53c2\u6570\u540d\u7b49\u4fe1\u606f\u3002  \n\n**\u8f93\u51fa**  \n- \u4fee\u6539\u540e\u7684 `fixturedef.func` \u4e3a\u4e0a\u8ff0\u5305\u88c5\u51fd\u6570\uff0c\u4f7f\u5f97\u540e\u7eed pytest \u5728\u6267\u884c\u8be5 fixture \u65f6\u80fd\u591f\u5728\u4e8b\u4ef6\u5faa\u73af\u4e2d\u8fd0\u884c\u5e76\u8fd4\u56de", "prompt_id": "28ad819ea97a795ed2ae85e64d974c5c", "created_at": "2026-02-04T20:58:25.760394"}