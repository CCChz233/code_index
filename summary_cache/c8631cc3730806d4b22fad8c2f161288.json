{"summary": "- The code defines a function `handle_anthropic_tools` that processes response models for Anthropic tools.\n- It takes a response model type `response_model` and a dictionary `new_kwargs` as inputs.\n- The function extracts the Anthropic schema from the response model and adds it to the `new_kwargs` dictionary.\n- It also sets the `tool_choice` and `system` (if any) to the appropriate values.\n- The final output is a tuple containing the modified `response_model` and `new_kwargs`.\nWe need to produce a summary in Chinese (or Chinese/English). Must start directly with the summary content, no preamble. Should focus on business logic, inputs, outputs. Provide concise description.\n\nThe code snippet includes many imports and a function handle_anthropic_tools. The summary should describe that function's purpose: adapt response model for Anthropic tool usage, modify kwargs for OpenAI chat completion, handling system messages, etc.\n\nLet's produce Chinese summary. Ensure start directly with content. No \"This code does\". Provide business logic: input response_model class with anthropic_schema attribute, new_kwargs dict containing messages, system, etc. Output tuple (response_model, new_kwargs) with tools list, tool_choice dict, combined system messages, filtered messages.\n\nLet's write.assistantfinal\u5904\u7406 Anthropic \u5de5\u5177\u7684\u9002\u914d\u51fd\u6570 `handle_anthropic_tools`  \n- **\u8f93\u5165**  \n  1. `response_model: type[T]` \u2013 \u7ee7\u627f\u81ea `BaseModel` \u7684\u54cd\u5e94\u6a21\u578b\u7c7b\uff0c\u5fc5\u987b\u5305\u542b `anthropic_schema`\uff08Anthropic \u5de5\u5177\u63cf\u8ff0\uff09\u3002  \n  2. `new_kwargs: dict[str, Any]` \u2013 \u4f20\u9012\u7ed9 OpenAI/Anthropic \u804a\u5929\u63a5\u53e3\u7684\u53c2\u6570\u5b57\u5178\uff0c\u5e38\u89c1\u952e\u5305\u62ec `messages`\uff08\u5bf9\u8bdd\u5217\u8868\uff09\u548c `system`\uff08\u7cfb\u7edf\u63d0\u793a\uff09\u3002  \n- **\u4e1a\u52a1\u903b\u8f91**  \n  1. \u8bfb\u53d6 `response_model.anthropic_schema`\uff0c\u5c06\u5176\u5305\u88c5\u4e3a\u5355\u5143\u7d20\u5217\u8868\u5e76\u5199\u5165 `new_kwargs[\"tools\"]`\uff0c\u7528\u4e8e\u5411\u6a21\u578b\u58f0\u660e\u53ef\u8c03\u7528\u7684\u5de5\u5177\u3002  \n  2. \u8bbe\u7f6e `new_kwargs[\"tool_choice\"]` \u4e3a\u56fa\u5b9a\u7ed3\u6784 `{ \"type\": \"tool\", \"name\": response_model.__name__ }`\uff0c\u6307\u793a\u6a21\u578b\u5728\u751f\u6210\u65f6\u5fc5\u987b\u9009\u62e9\u8be5\u5de5\u5177\u3002  \n  3. \u4ece `new_kwargs[\"messages\"]` \u4e2d\u63d0\u53d6\u6240\u6709 `role=\"system\"` \u7684\u7cfb\u7edf\u6d88\u606f\uff08`extract_system_messages`", "prompt_id": "28ad819ea97a795ed2ae85e64d974c5c", "created_at": "2026-02-04T20:43:58.041314"}